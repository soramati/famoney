<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤«å©¦ã®å½¹å‰²åˆ†æ‹…ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; background: #fdfaf6; color: #4a4a4a; padding: 20px; display: flex; justify-content: center; }
        .card { background: white; padding: 2rem; border-radius: 20px; box-shadow: 0 12px 30px rgba(0,0,0,0.08); width: 100%; max-width: 800px; }
        h2 { text-align: center; margin-bottom: 20px; }
        .toggle-container { text-align: center; margin-bottom: 25px; background: #f0f0f0; padding: 12px; border-radius: 12px; }
        .toggle-container label { cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .charts-wrapper { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px; margin-bottom: 30px; }
        .chart-box { width: 300px; text-align: center; }
        .chart-title { font-weight: bold; margin-bottom: 10px; font-size: 0.9rem; color: #888; }
        .chart-container { height: 250px; width: 250px; margin: 0 auto; position: relative; }
        .controls { max-width: 550px; margin: 0 auto; }
        .control-group { margin-bottom: 2rem; }
        .hidden { display: none; }
        .label-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-weight: bold; }
        .pct-label { color: #e67e22; font-size: 1.1rem; }
        input[type="range"] { width: 100%; cursor: pointer; height: 8px; border-radius: 10px; background: #ddd; -webkit-appearance: none; margin-bottom: 12px; }
        #money-slider { accent-color: #ffb3ba; }
        #house-slider { accent-color: #bae1ff; }
        #child-slider { accent-color: #baffc9; }
        
        /* è¨ˆç®—è¡Œã¨å˜ä½é¸æŠã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .calc-row { font-size: 0.9rem; color: #666; display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
        .unit-select { border: none; border-bottom: 1px solid #ccc; background: transparent; font-size: 0.9rem; color: #4a4a4a; cursor: pointer; padding: 2px; outline: none; }
        .unit-select:focus { border-bottom: 2px solid #e67e22; }
        .total-input { border: none; border-bottom: 1px solid #ccc; width: 90px; text-align: right; font-size: 1rem; padding: 2px; outline: none; background: transparent; }
        .total-input:focus { border-bottom: 2px solid #e67e22; }
        .result-text { font-weight: bold; color: #d35400; border-bottom: 1px solid #d35400; min-width: 40px; display: inline-block; text-align: center; }
        
        .footer-note { font-size: 0.75rem; color: #bbb; text-align: center; margin-top: 2rem; line-height: 1.5; background: #fff; padding: 10px; border-radius: 8px; border: 1px dashed #ddd; }
    </style>
</head>
<body>

<div class="card">
    <h2>å¤«å©¦ã®å½¹å‰²åˆ†æ‹…ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h2>

    <div class="toggle-container">
        <label>
            <input type="checkbox" id="child-mode-toggle" checked>
            ğŸ¼ è‚²å…è² æ‹…ã‚’å«ã‚ã‚‹ (ã‚ªãƒ³:300p / ã‚ªãƒ•:200p)
        </label>
    </div>
    
    <div class="charts-wrapper">
        <div class="chart-box">
            <div class="chart-title">ğŸ‘¤ ã‚ãªãŸã®åˆ†æ‹…</div>
            <div class="chart-container"><canvas id="userChart"></canvas></div>
        </div>
        <div class="chart-box">
            <div class="chart-title">ğŸ¤ ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®åˆ†æ‹…</div>
            <div class="chart-container"><canvas id="partnerChart"></canvas></div>
        </div>
    </div>

    <div class="controls">
        <div class="control-group">
            <div class="label-row">
                <span>å®¶è¨ˆè² æ‹…</span>
                <span class="pct-label"><span id="money-pct">50</span>%</span>
            </div>
            <input type="range" id="money-slider" min="0" max="200" value="100">
            <div class="calc-row">
                å…¨ä½“ã§ 
                <select class="unit-select" id="money-unit">
                    <option value="å¹´">å¹´</option>
                    <option value="æœˆ" selected>æœˆ</option>
                    <option value="é€±">é€±</option>
                    <option value="æ—¥">æ—¥</option>
                </select>
                <input type="number" id="money-total" class="total-input" value="200000"> å††ã®ã¨ã â” ã‚ãªãŸã¯ <span class="result-text" id="money-result">100,000</span> å††
            </div>
        </div>

        <div class="control-group">
            <div class="label-row">
                <span>å®¶äº‹è² æ‹…</span>
                <span class="pct-label"><span id="house-pct">50</span>%</span>
            </div>
            <input type="range" id="house-slider" min="0" max="200" value="100">
            <div class="calc-row">
                å…¨ä½“ã§ 
                <select class="unit-select" id="house-unit">
                    <option value="å¹´">å¹´</option>
                    <option value="æœˆ" selected>æœˆ</option>
                    <option value="é€±">é€±</option>
                    <option value="æ—¥">æ—¥</option>
                </select>
                <input type="number" id="house-total" class="total-input" value="100"> æ™‚é–“ã®ã¨ã â” ã‚ãªãŸã¯ <span class="result-text" id="house-result">50</span> æ™‚é–“
            </div>
        </div>

        <div class="control-group" id="child-control-group">
            <div class="label-row">
                <span>è‚²å…è² æ‹…</span>
                <span class="pct-label"><span id="child-pct">50</span>%</span>
            </div>
            <input type="range" id="child-slider" min="0" max="200" value="100">
            <div class="calc-row">
                å…¨ä½“ã§ 
                <select class="unit-select" id="child-unit">
                    <option value="å¹´">å¹´</option>
                    <option value="æœˆ" selected>æœˆ</option>
                    <option value="é€±">é€±</option>
                    <option value="æ—¥">æ—¥</option>
                </select>
                <input type="number" id="child-total" class="total-input" value="150"> æ™‚é–“ã®ã¨ã â” ã‚ãªãŸã¯ <span class="result-text" id="child-result">75</span> æ™‚é–“
            </div>
        </div>
    </div>

    <div class="footer-note">
        âœ… <strong>è¨­å®šã¯è‡ªå‹•ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™</strong><br>
        æœŸé–“ï¼ˆå¹´ãƒ»æœˆãƒ»é€±ãƒ»æ—¥ï¼‰ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ã€æŸ”è»Ÿã«ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ãã¾ã™ã€‚
    </div>
</div>

<script>
    let userChart, partnerChart;
    const STORAGE_KEY = 'family_balance_data_v2'; // æ§‹é€ ãŒå¤‰ã‚ã£ãŸãŸã‚ã‚­ãƒ¼ã‚’æ›´æ–°
    
    const sliders = { money: document.getElementById('money-slider'), house: document.getElementById('house-slider'), child: document.getElementById('child-slider') };
    const totals = { money: document.getElementById('money-total'), house: document.getElementById('house-total'), child: document.getElementById('child-total') };
    const units = { money: document.getElementById('money-unit'), house: document.getElementById('house-unit'), child: document.getElementById('child-unit') };
    const pcts = { money: document.getElementById('money-pct'), house: document.getElementById('house-pct'), child: document.getElementById('child-pct') };
    const results = { money: document.getElementById('money-result'), house: document.getElementById('house-result'), child: document.getElementById('child-result') };
    const childToggle = document.getElementById('child-mode-toggle');
    const childControl = document.getElementById('child-control-group');

    function saveData() {
        const data = {
            sliders: { money: sliders.money.value, house: sliders.house.value, child: sliders.child.value },
            totals: { money: totals.money.value, house: totals.house.value, child: totals.child.value },
            units: { money: units.money.value, house: units.house.value, child: units.child.value },
            isChildOn: childToggle.checked
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function loadData() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (!saved) return;
        const data = JSON.parse(saved);
        childToggle.checked = data.isChildOn;
        if (data.isChildOn) childControl.classList.remove('hidden'); else childControl.classList.add('hidden');
        
        Object.keys(data.sliders).forEach(key => {
            if (sliders[key]) sliders[key].value = data.sliders[key];
            if (totals[key]) totals[key].value = data.totals[key];
            if (units[key]) units[key].value = data.units[key];
        });
    }

    function init() {
        loadData();
        const ctxUser = document.getElementById('userChart').getContext('2d');
        const ctxPartner = document.getElementById('partnerChart').getContext('2d');
        const config = {
            type: 'pie',
            data: { labels: ['å®¶è¨ˆ', 'å®¶äº‹', 'è‚²å…'], datasets: [{ data: [100, 100, 100], backgroundColor: ['#ffb3ba', '#bae1ff', '#baffc9'], borderWidth: 1 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } } } }
        };
        userChart = new Chart(ctxUser, JSON.parse(JSON.stringify(config)));
        partnerChart = new Chart(ctxPartner, JSON.parse(JSON.stringify(config)));
        updateAll();
    }

    function updateAll() {
        if (!userChart) return;
        const isChildOn = childToggle.checked;
        const userValues = [];
        const partnerValues = [];
        const labels = isChildOn ? ['å®¶è¨ˆ', 'å®¶äº‹', 'è‚²å…'] : ['å®¶è¨ˆ', 'å®¶äº‹'];
        const colors = isChildOn ? ['#ffb3ba', '#bae1ff', '#baffc9'] : ['#ffb3ba', '#bae1ff'];

        ['money', 'house', 'child'].forEach(key => {
            if (!isChildOn && key === 'child') return;
            const uVal = parseInt(sliders[key].value);
            const pVal = 200 - uVal;
            const total = parseFloat(totals[key].value) || 0;
            const ratio = uVal / 200;
            pcts[key].innerText = Math.round(ratio * 100);
            results[key].innerText = (total * ratio).toLocaleString(undefined, { maximumFractionDigits: 1 });
            userValues.push(uVal);
            partnerValues.push(pVal);
        });

        userChart.data.labels = labels;
        userChart.data.datasets[0].data = userValues;
        userChart.data.datasets[0].backgroundColor = colors;
        userChart.update();
        partnerChart.data.labels = labels;
        partnerChart.data.datasets[0].data = partnerValues;
        partnerChart.data.datasets[0].backgroundColor = colors;
        partnerChart.update();
        saveData();
    }

    function handleInput(e) {
        const isChildOn = childToggle.checked;
        const limit = isChildOn ? 300 : 200;
        const changedId = e.target.id.split('-')[0];
        const activeKeys = isChildOn ? ['money', 'house', 'child'] : ['money', 'house'];
        const otherIds = activeKeys.filter(id => id !== changedId);
        let val = parseInt(sliders[changedId].value);
        const remain = limit - val;
        let otherSum = otherIds.reduce((sum, id) => sum + parseInt(sliders[id].value), 0);
        if (otherSum === 0) {
            otherIds.forEach(id => sliders[id].value = remain / otherIds.length);
        } else {
            const ratio = remain / otherSum;
            otherIds.forEach((id, index) => {
                if (index === otherIds.length - 1) {
                    let currentOthers = activeKeys.filter(k => k !== changedId && k !== id).reduce((s, k) => s + parseInt(sliders[k].value), 0);
                    sliders[id].value = limit - val - currentOthers;
                } else { sliders[id].value = Math.round(parseInt(sliders[id].value) * ratio); }
            });
        }
        updateAll();
    }

    childToggle.addEventListener('change', () => {
        if (childToggle.checked) { childControl.classList.remove('hidden'); sliders.child.value = 100; } 
        else { childControl.classList.add('hidden'); sliders.child.value = 0; sliders.money.value = 100; sliders.house.value = 100; }
        updateAll();
    });

    Object.values(sliders).forEach(s => s.addEventListener('input', handleInput));
    Object.values(totals).forEach(t => t.addEventListener('input', updateAll));
    Object.values(units).forEach(u => u.addEventListener('change', updateAll)); // å˜ä½å¤‰æ›´ã§ã‚‚ä¿å­˜

    window.onload = init;
</script>

</body>
</html>